{% extends "base.html" %}
{% load static %}

{% block body_class %}user-theme{% endblock body_class %}

{% block nav %}{% endblock nav %}

{% block title %}
<title>User Dashboard</title>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/userdashboard-aurora.css' %}">
{% endblock extra_css %}

{% block content %}

<!-- ===== OVERLAY ===== -->
<div class="overlay" id="overlay"></div>

<!-- ===== SIDEBAR ===== -->
<div class="sidebar" id="sidebar">
  <div class="user-box">
    <img src="{{ data.image.url }}" onerror="this.src='https://via.placeholder.com/90'">
    <h6>{{ data.name }}</h6>
    <small>{{ data.email }}</small>
  </div>
  <a href="{% url 'profile' %}"><i class="bi bi-person-circle"></i> <span>Profile</span></a>
  <a href="{% url 'query' %}"><i class="bi bi-question-circle"></i> <span>Raise Query</span></a>
  <a href="{% url 'query_status' %}"><i class="bi bi-bar-chart-line"></i> <span>Query Status</span></a>
  <a href="{% url 'all_query' %}"><i class="bi bi-card-list"></i> <span>All Queries</span></a>
</div>

<!-- ===== TOPBAR ===== -->
<div class="topbar">
  <button id="menu-btn">&#9776;</button>
  <a href="{% url 'logout' %}" class="btn btn-danger btn-sm">Logout</a>
</div>

<!-- ===== MAIN CONTENT ===== -->
<div class="main-content">

  {% if not profile and not query and not query_status and not all_query and not e_query %}
  <h4 class="mb-4">Welcome, <span class="gradient-text">{{ data.name }}</span></h4>
  <div class="user-hero-grid">
    <div class="user-hero-panel">
      <div class="hero-glass">
        <h6>Workspace Overview</h6>
        <p>Track profile, submit queries, and monitor status updates from one responsive dashboard.</p>
        <div class="hero-cta-row">
          <a href="{% url 'profile' %}" class="btn btn-light btn-sm text-dark">Profile</a>
          <a href="{% url 'query' %}" class="btn btn-outline-light btn-sm">Raise Query</a>
          <a href="{% url 'query_status' %}" class="btn btn-outline-light btn-sm">Status</a>
        </div>
      </div>
    </div>
    <div class="user-mini-stack">
      <div class="user-stat-card">
        <div class="icon"><i class="bi bi-person-badge"></i></div>
        <strong>{{ data.department|default:"Department" }}</strong>
        <span>Current Department</span>
      </div>
      <div class="user-stat-card">
        <div class="icon"><i class="bi bi-envelope-check"></i></div>
        <strong>Profile Ready</strong>
        <span>Account Details Active</span>
      </div>
      <div class="user-stat-card">
        <div class="icon"><i class="bi bi-chat-left-text"></i></div>
        <strong>Query Desk</strong>
        <span>Raise and manage requests</span>
      </div>
      <div class="user-stat-card">
        <div class="icon"><i class="bi bi-shield-check"></i></div>
        <strong>Secure Access</strong>
        <span>Session-based dashboard</span>
      </div>
    </div>
  </div>
  {% endif %}

  {% if profile %}
  <div class="card shadow p-4" style="max-width:450px; margin:auto;">
    <div class="text-center mb-3">
      <img src="{{ data.image.url }}" onerror="this.src='https://via.placeholder.com/120'">
    </div>
    <h5 class="text-center mb-3 gradient-text">My Profile</h5>
    <p><strong>Name:</strong> {{ data.name }}</p>
    <p><strong>Email:</strong> {{ data.email }}</p>
    <p><strong>Contact:</strong> {{ data.contact }}</p>
    <p><strong>Department:</strong> {{ data.department }}</p>
  </div>
  {% endif %}

  {% if query %}
  <div class="card shadow p-4 no-top-line">
    <h5 class="mb-3 gradient-text">Raise Query</h5>
    <form method="post" action="{% url 'query_data' %}">
      {% csrf_token %}
      <input class="form-control mb-3" name="name" value="{{ data.name }}" readonly>
      <input class="form-control mb-3" name="email" value="{{ data.email }}" readonly>
      <select name="subject" class="form-control mb-3"> Subject
        <option value="option">--Select Subject--</option>
        <option value="attandance">Attandance</option>
        <option value="salary">Salary</option>
        <option value="profile">Profile</option>
        <option value="leave">Leave</option>
      </select>
      
      <textarea name="query" class="form-control mb-3" rows="4" placeholder="Write your query here..."></textarea>
      <button class="btn btn-primary">Submit</button>
    </form>
  </div>
  {% endif %}

{% if query_status %}
<div class="card shadow-lg p-4 table-responsive rounded-4 no-top-line query-status-card">

  <!-- ===== HEADER + CONTROLS ===== -->
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3 query-status-toolbar">

    <h5 class="mb-0 gradient-text fw-bold">
      <i class="bi bi-chat-left-text"></i> Query Status
    </h5>

    <!-- üîç SEARCH + SORT + RESET -->
    <form method="post" class="d-flex flex-wrap align-items-center gap-2">
      {% csrf_token %}

      <!-- Search -->
      <input type="text" name="search"
             class="form-control form-control-sm shadow-sm"
             placeholder="Search query / subject / status"
             value="{{ request.POST.search }}"
             style="min-width:220px;">

      <!-- Search Button -->
      <button type="submit" class="btn btn-sm btn-primary shadow-sm">
        <i class="bi bi-search"></i> Search
      </button>

      <!-- Latest First -->
      <button type="submit" name="sort" value="latest"
              class="btn btn-sm btn-outline-success shadow-sm">
        <i class="bi bi-arrow-down"></i> Latest First
      </button>

      <!-- Oldest First -->
      <button type="submit" name="sort" value="oldest"
              class="btn btn-sm btn-outline-warning shadow-sm">
        <i class="bi bi-arrow-up"></i> Oldest First
      </button>

      <!-- Reset -->
      <a href="" class="btn btn-sm btn-outline-secondary shadow-sm">
        <i class="bi bi-arrow-counterclockwise"></i> Reset
      </a>
    </form>
  </div>

  <!-- ===== TABLE ===== -->
  <table class="table table-hover table-striped align-middle">
    <thead class="table-dark text-center">
      <tr>
        <th>S.no.</th>
        <th>Name</th>
        <th>Email</th>
        <th>Query</th>
        <th>Subject</th>
        <th>Status</th>
        <th>Solution</th>
      </tr>
    </thead>

    <tbody>
      {% for q in query_status %}
      <tr>
        <td class="text-center fw-semibold">{{ forloop.counter }}</td>
        <td>{{ q.name }}</td>
        <td>{{ q.email }}</td>
        <td>{{ q.message }}</td>
        <td>{{ q.subject }}</td>
        <td class="text-center">
          {% with s=q.status|lower %}
          <span class="badge rounded-pill px-3 py-2
            {% if s == 'pending' or s == 'panding' %}bg-warning text-dark
            {% elif s == 'done' or s == 'resolved' %}bg-success
            {% else %}bg-secondary{% endif %}">
            {{ q.status }}
          </span>
          {% endwith %}
        </td>
        <td>{{ q.solution|default:"‚Äî" }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="text-center text-danger fw-semibold py-4">
          No records found
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

</div>
{% endif %}

{% if all_query %}
<div class="card shadow p-4 table-responsive no-top-line all-query-card">

  <!-- ===== HEADER ===== -->
  <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 gap-3">
    <h5 class="mb-0 gradient-text">All Queries</h5>
  </div>

  <!-- ===== SEARCH FORM (COLUMN WISE) ===== -->
  <form action="{% url 'search' %}" method="post">
    {% csrf_token %}

    <table class="table table-bordered table-hover table-striped" id="queryTable">
      <thead class="table-dark">
        <!-- üîç SEARCH ROW -->
        <tr>
          <th></th>
          <th>
            <input type="text" name="name" 
                   class="form-control form-control-sm"
                   placeholder="Search Name">
          </th>
          <th>
            <!-- <input type="text" name="email" 
                   class="form-control form-control-sm"
                   placeholder="Search Email"> -->
          </th>
          <th>
            <input type="text" name="message" 
                   class="form-control form-control-sm"
                   placeholder="Search Query">
          </th>
          <th>
            <input type="text" name="status"
                   class="form-control form-control-sm"
                   placeholder="Search Status">
          </th>
          <th colspan="2" class="text-center">
            <button type="submit" class="btn btn-primary btn-sm w-100 mb-1">
              üîç Search
            </button>
            <a href="{% url 'reset' %}" class="btn btn-secondary btn-sm w-100">
              ‚ùå Reset
            </a>
          </th>
        </tr>

        <!-- ===== HEADING ROW ===== -->
        <tr>
          <th>S.No</th>
          <th>Name</th>
          <th>Email</th>
          <th>Query</th>
          <th>Status</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>

      <tbody>
        {% for q in all_query %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ q.name }}</td>
          <td>{{ q.email }}</td>
          <td>{{ q.message }}</td>
          <td>{{ q.status }}</td>

          <td>
            {% if q.status == "panding" %}
            <a href="{% url 'edit_query' pk=q.id %}" class="btn btn-sm btn-warning">
              <i class="bi bi-pencil-square"></i> Edit
            </a>
            {% else %}
            <button class="btn btn-secondary btn-sm" disabled>Locked</button>
            {% endif %}
          </td>

          <td>
            {% if q.status == "panding" %}
            <a href="{% url 'delete_query' pk=q.id %}" class="btn btn-sm btn-danger"
               onclick="return confirm('Are you sure?')">
              <i class="bi bi-trash"></i> Delete
            </a>
            {% else %}
            <button class="btn btn-secondary btn-sm" disabled>Locked</button>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center">No Queries Found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>

</div>
{% endif %}


  {% if e_query %}
        <div class="query-card">
            <form action="{% url 'Update_query' pk=e_query.id %}" method="post">
                {% csrf_token %}

                <h3 class="query-title">Update Your Query</h3>

                <div class="query-field">
                    <input type="text" name="name" value="{{ e_query.name }}">
                </div>

                <div class="query-field">
                    <input type="email" name="email" value="{{ e_query.email }}">
                </div>

                <div class="query-field">
                    <select name="subject">
                        <option value="">--Subject--</option>

                        <option value="Attendence" {% if e_query.subject == "Attendence" %}selected{% endif %}>Attendence
                        </option>
                        <option value="Salary" {% if e_query.subject == "Salary" %}selected{% endif %}>Salary</option>
                        <option value="Profile" {% if e_query.subject == "Profile" %}selected{% endif %}>Profile</option>
                        <option value="Leave" {% if e_query.subject == "Leave" %}selected{% endif %}>Leave</option>
                    </select>
                </div>

                <br>

                <div class="query-field">
                    <textarea name="query" placeholder="Your Query">{{ e_query.query }}</textarea>
                </div>

                <button class="query-btn" type="submit">Update</button>
            </form>
  {% endif %}

        </div>
</div>

<script>
// Sidebar toggle for mobile
const menuBtn = document.getElementById('menu-btn');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const body = document.body;

menuBtn.addEventListener('click', () => {
    sidebar.classList.toggle('show');
    overlay.style.display = sidebar.classList.contains('show') ? 'block' : 'none';
    body.classList.toggle('sidebar-open', sidebar.classList.contains('show'));
});

overlay.addEventListener('click', () => {
    sidebar.classList.remove('show');
    overlay.style.display = 'none';
    body.classList.remove('sidebar-open');
});

// Simple search filter
const searchInput = document.getElementById('searchInput');
if(searchInput){
    searchInput.addEventListener('keyup', function() {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll('#queryTable tbody tr');
        rows.forEach(row => {
            const queryText = row.cells[1].textContent.toLowerCase();
            row.style.display = queryText.includes(filter) ? '' : 'none';
        });
    });
}
</script>
{% endblock %}





